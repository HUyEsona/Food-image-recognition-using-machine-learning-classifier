<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Food Recognition</title>
    <link rel="stylesheet" href="/CSS/style.css">
</head>
<body>
<!-- ================= HEADER + NAV ================= -->
<div class="header" id="home">
    <div class="header-content">
        <div class="logo">
            <div class="icon-box">üç¥</div>
            <h1 class="title">Food Recognition</h1>
        </div>
        
        <nav class="nav-menu">
            <a href="../navigation_menu/index.html" class="active">Trang ch·ªß</a>
            <a href="../navigation_menu/about.html">Gi·ªõi thi·ªáu</a>
            <a href="../navigation_menu/reason.html">L√Ω do</a>
            <a href="../navigation_menu/contact.html">Li√™n h·ªá</a>
        </nav>
    </div>
</div>

<!-- ================= MAIN ================= -->
<div class="container">
    <div class="main-layout">
        <!-- Banner -->
        <div class="banner">
            <h2 class="banner-title">
                Hi·ªÉu m√≥n ƒÉn c·ªßa b·∫°n ƒë·ªÉ s·ªëng kh·ªèe h∆°n!
            </h2>
        </div>

        <!-- Upload content -->
        <div class="content">
            <div id="uploadSection">
                <div class="upload-text upload-title">
                    Ch·ªçn lo·∫°i ·∫£nh b·∫°n mu·ªën ph√¢n t√≠ch:
                </div>

                <div class="upload-type">
                    <div class="upload-option" onclick="selectType(this, 'ingredient')">
                        <div class="option-title">Th·ª±c ph·∫©m</div>
                    </div>
                    <div class="upload-option" onclick="selectType(this, 'dish')">
                        <div class="option-title">M√≥n ƒÉn</div>
                    </div>
                </div>

                <div class="upload-btn"
                     onclick="document.getElementById('fileInput').click()">
                    Ch·ªçn ·∫£nh
                </div>

                <div class="upload-text">Nh·∫•n ƒë·ªÉ ch·ªçn ·∫£nh</div>

                <input type="file" id="fileInput" accept="image/*" />
            </div>

            <div id="previewSection" class="card-image hidden">
                <img id="previewImage" class="image" alt="Preview" />
                <div class="button-row">
                    <button class="btn btn-success" onclick="analyzeFood()">Ph√¢n t√≠ch</button>
                    <button class="btn btn-gray" onclick="reset()">H·ªßy</button>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- ================= SCRIPT ================= -->
<script>
    let currentImage = null;
    let selectedType = null;

    // Debug log
    console.log('Food Recognition Script Loaded');

    function selectType(element, type) {
        console.log('Selected type:', type);
        document.querySelectorAll('.upload-option').forEach(opt => {
            opt.classList.remove('selected');
        });
        element.classList.add('selected');
        selectedType = type;
    }

    document.getElementById('fileInput').addEventListener('change', function (e) {
        const file = e.target.files[0];
        console.log('File selected:', file?.name);
        
        if (file) {
            if (!selectedType) {
                alert('Vui l√≤ng ch·ªçn lo·∫°i ·∫£nh tr∆∞·ªõc!');
                return;
            }
            const reader = new FileReader();
            reader.onload = function (event) {
                currentImage = file;
                document.getElementById('previewImage').src = event.target.result;
                document.getElementById('uploadSection').classList.add('hidden');
                document.getElementById('previewSection').classList.remove('hidden');
                console.log('Image preview loaded');
            };
            reader.readAsDataURL(file);
        }
    });

    async function analyzeFood() {
        console.log('analyzeFood() called');
        console.log('   - currentImage:', currentImage?.name);
        console.log('   - selectedType:', selectedType);

        if (!currentImage || !selectedType) {
            alert('C√≥ l·ªói x·∫£y ra. Vui l√≤ng th·ª≠ l·∫°i!');
            console.error('Missing currentImage or selectedType');
            return;
        }

        const analyzeBtn = document.querySelector('.btn-success');
        const originalText = analyzeBtn.textContent;
        analyzeBtn.textContent = 'ƒêang ph√¢n t√≠ch...';
        analyzeBtn.disabled = true;

        try {
            const formData = new FormData();
            formData.append('image', currentImage);
            formData.append('type', selectedType);

            console.log('Sending request to: http://localhost:5000/api/predict');

            const response = await fetch('http://localhost:5000/api/predict', {
                method: 'POST',
                body: formData
            });

            console.log('Response status:', response.status);

            const data = await response.json();
            console.log('Response data:', data);

            if (data.status === 'success') {
                displayResults(data);
            } else {
                alert('L·ªói: ' + (data.message || 'Kh√¥ng th·ªÉ ph√¢n t√≠ch ·∫£nh'));
                console.error('API returned error:', data);
            }
        } catch (error) {
            console.error('Fetch error:', error);
            alert('Kh√¥ng th·ªÉ k·∫øt n·ªëi ƒë·∫øn server!\n\nChi ti·∫øt l·ªói: ' + error.message + '\n\nKi·ªÉm tra:\n1. Flask ƒë√£ ch·∫°y ch∆∞a?\n2. ƒêang m·ªü t·ª´ http://localhost:5000 ?');
        } finally {
            analyzeBtn.textContent = originalText;
            analyzeBtn.disabled = false;
        }
    }

    function displayResults(data) {
    console.log('Displaying results:', data);
    
    const { predictions, model, type } = data;
    
    // L·∫•y src c·ªßa ·∫£nh hi·ªán t·∫°i
    const currentImageSrc = document.getElementById('previewImage').src;
    
    let resultHTML = `
        <!-- Hi·ªÉn th·ªã ·∫£nh ƒë√£ ch·ªçn -->
        <div style="text-align: center; margin-bottom: 20px;">
            <img src="${currentImageSrc}" 
                 style="max-width: 100%; max-height: 400px; object-fit: contain; 
                        border-radius: 8px; box-shadow: 0 4px 6px rgba(0,0,0,0.1);" 
                 alt="Selected Image" />
        </div>
        
        <div style="padding: 24px; text-align: left;">
            <div style="background: linear-gradient(135deg, #F97316 0%, #EF4444 100%); 
                        padding: 16px; border-radius: 8px; margin-bottom: 20px; color: white;">
                <h3 style="margin: 0;">K·∫øt qu·∫£ ph√¢n t√≠ch</h3>
                <p style="margin: 8px 0 0 0; opacity: 0.9; font-size: 14px;">
                    Model: ${model} | Lo·∫°i: ${type === 'dish' ? 'M√≥n ƒÉn' : 'Th·ª±c ph·∫©m'}
                </p>
            </div>
    `;
    
    predictions.forEach((pred, index) => {
        const isTop = index === 0;
        const bgColor = isTop ? '#EFF6FF' : '#F9FAFB';
        const borderColor = isTop ? '#3B82F6' : '#E5E7EB';
        
        resultHTML += `
            <div style="margin-bottom: 12px; padding: 16px; 
                        background: ${bgColor}; 
                        border: 2px solid ${borderColor};
                        border-radius: 8px;">
                <div style="display: flex; justify-content: space-between; align-items: center;">
                    <div>
                        <div style="font-weight: 600; font-size: 18px; color: #111827;">
                            ${index + 1}. ${pred.name}
                        </div>
                        <div style="color: #6B7280; font-size: 14px; margin-top: 4px;">
                            ${isTop ? 'K·∫øt qu·∫£ t·ªët nh·∫•t' : 'Kh·∫£ nƒÉng kh√°c'}
                        </div>
                    </div>
                    <div style="text-align: right;">
                        <div style="font-size: 24px; font-weight: bold; color: #059669;">
                            ${pred.confidence.toFixed(1)}%
                        </div>
                        <div style="width: 100px; height: 8px; background: #E5E7EB; 
                                    border-radius: 4px; margin-top: 4px; overflow: hidden;">
                            <div style="width: ${pred.confidence}%; height: 100%; 
                                        background: #059669; border-radius: 4px;"></div>
                        </div>
                    </div>
                </div>
            </div>
        `;
    });
    
    resultHTML += `
            <div style="margin-top: 20px; padding-top: 20px; border-top: 2px solid #E5E7EB;">
                <button class="btn btn-gray" onclick="reset()" 
                        style="width: 100%; padding: 14px; font-size: 16px;">
                    Ph√¢n t√≠ch ·∫£nh kh√°c
                </button>
            </div>
        </div>
    `;
    
    document.getElementById('previewSection').innerHTML = resultHTML;
}

    function reset() {
        console.log('Reset');
        currentImage = null;
        selectedType = null;
        document.getElementById('fileInput').value = '';
        document.querySelectorAll('.upload-option').forEach(opt => {
            opt.classList.remove('selected');
        });
        
        const previewSection = document.getElementById('previewSection');
        previewSection.innerHTML = `
            <img id="previewImage" class="image" alt="Preview" />
            <div class="button-row">
                <button class="btn btn-success" onclick="analyzeFood()">Ph√¢n t√≠ch</button>
                <button class="btn btn-gray" onclick="reset()">H·ªßy</button>
            </div>
        `;
        
        document.getElementById('uploadSection').classList.remove('hidden');
        document.getElementById('previewSection').classList.add('hidden');
    }

    // Test sever
    fetch('http://localhost:5000/api/health')
        .then(res => res.json())
        .then(data => {
            console.log('Server connected:', data);
        })
        .catch(err => {
            console.error('Kh√¥ng th·ªÉ k·∫øt n·ªëi ƒë·∫øn server:', err);
            console.warn('ƒë·∫£m b·∫£o Flask ƒëang ch·∫°y tr√™n c·ªïng 5000');
        });
</script>
</body>
</html>